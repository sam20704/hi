#!/usr/bin/env python3

import logging
import re
import difflib
from pathlib import Path
from redlines import Redlines  

# CONFIGURATION
def configure_logging(level=logging.INFO):
    """Configure logging to standard Azure stdout format."""
    logging.basicConfig(
        level=level,
        format="%(asctime)s - %(levelname)s - - %(message)s"
    )


# Normalization
def normalize_text(text: str) -> str:
    
    # Normalizes legal text to ensure 'visual' differences aren't flagged.
    # Unifies whitespace (tabs to spaces).
    # Standardizes quotes (curly to straight).
    
    if not text:
        return ""
    text = text.replace("“", '"').replace("”", '"').replace("’", "'")
    text = re.sub(r"\s+", " ", text)  # Collapse multiple spaces
    return text.strip()



def generate_legal_redline(reference_text: str, incoming_text: str) -> dict:
    
    # Generates a 'Track Changes' style difference using Redlines (diff-match-patch).
    #Returns: dict with status, markdown diff, and a numeric change_ratio.
    
    clean_old = normalize_text(reference_text)
    clean_new = normalize_text(incoming_text)

    if clean_old == clean_new:
        return {
            "status": "MATCH",
            "diff_markdown": None,
            "change_ratio": 0.0
        }

    
    differ = Redlines(clean_old, clean_new)
    redline_text = differ.compare()

    # Use difflib SequenceMatcher to approximate similarity
    matcher = difflib.SequenceMatcher(None, clean_old, clean_new)
    similarity = matcher.ratio()       # 0..1 (1 = identical)
    change_ratio = 1.0 - similarity    # 0..1 (1 = completely different)

    return {
        "status": "CHANGED",
        "diff_markdown": redline_text,
        "change_ratio": change_ratio
    }

def get_legal_redline_for_document(document_text: str) -> dict:
    configure_logging()
    #replace this with real template text/ section-level-logic
    reference_text = (
        #example : The Contractor shall be liable for all damages up to $1,000,000
    )
    diff_result = generate_legal_redline(reference_text, document_text)

    return diff_result
